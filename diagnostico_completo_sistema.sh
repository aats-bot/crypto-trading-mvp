#!/bin/bash
# Script de Diagn√≥stico Completo do Sistema Enterprise

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
PURPLE='\033[0;35m'
WHITE='\033[1;37m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')] INFO:${NC} $1"
}

success() {
    echo -e "${GREEN}[$(date +'%H:%M:%S')] SUCCESS:${NC} $1"
}

error() {
    echo -e "${RED}[$(date +'%H:%M:%S')] ERROR:${NC} $1"
}

warning() {
    echo -e "${YELLOW}[$(date +'%H:%M:%S')] WARNING:${NC} $1"
}

diagnostic() {
    echo -e "${CYAN}[$(date +'%H:%M:%S')] DIAGNOSTIC:${NC} $1"
}

section() {
    echo ""
    echo -e "${WHITE}=================================================================="
    echo -e "üìä $1"
    echo -e "==================================================================${NC}"
    echo ""
}

echo "=================================================================="
echo "üîç DIAGN√ìSTICO COMPLETO DO SISTEMA ENTERPRISE"
echo "üéØ Mapeando TODOS os problemas para resolu√ß√£o definitiva"
echo "=================================================================="
echo ""

diagnostic "Iniciando diagn√≥stico completo em $(date)"

# ================================================================
# 1. STATUS DOS CONTAINERS
# ================================================================
section "1. STATUS DOS CONTAINERS"

log "Verificando status de todos os containers..."
if docker-compose -f docker-compose.production.yml ps; then
    success "‚úÖ Docker Compose funcionando"
else
    error "‚ùå Problema com Docker Compose"
fi

echo ""
log "Status detalhado dos containers:"
docker ps -a --filter "name=crypto-trading" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

echo ""
log "Verificando health checks:"
for container in crypto-trading-api crypto-trading-dashboard crypto-trading-postgres crypto-trading-redis crypto-trading-grafana crypto-trading-nginx crypto-trading-worker; do
    if docker ps --filter "name=$container" --format "{{.Names}}: {{.Status}}" 2>/dev/null | grep -q "$container"; then
        STATUS=$(docker ps --filter "name=$container" --format "{{.Status}}" 2>/dev/null || echo "Not found")
        if [[ "$STATUS" == *"healthy"* ]]; then
            success "‚úÖ $container: Healthy"
        elif [[ "$STATUS" == *"unhealthy"* ]]; then
            error "‚ùå $container: Unhealthy"
        elif [[ "$STATUS" == *"starting"* ]]; then
            warning "‚è≥ $container: Starting"
        else
            warning "‚ö†Ô∏è $container: $STATUS"
        fi
    else
        error "‚ùå $container: Not found"
    fi
done

# ================================================================
# 2. LOGS DOS CONTAINERS
# ================================================================
section "2. LOGS DOS CONTAINERS (√öLTIMAS 10 LINHAS)"

for container in api dashboard worker postgres redis grafana nginx; do
    log "Logs do $container:"
    if docker-compose -f docker-compose.production.yml logs --tail=10 $container 2>/dev/null; then
        echo ""
    else
        error "‚ùå N√£o foi poss√≠vel obter logs do $container"
        echo ""
    fi
done

# ================================================================
# 3. CONECTIVIDADE DE REDE
# ================================================================
section "3. CONECTIVIDADE DE REDE"

log "Verificando rede Docker..."
if docker network ls | grep -q "crypto-trading-network"; then
    success "‚úÖ Rede crypto-trading-network existe"
else
    error "‚ùå Rede crypto-trading-network n√£o encontrada"
fi

echo ""
log "Testando conectividade entre containers..."

# Teste de conectividade interna
if docker-compose -f docker-compose.production.yml exec -T api ping -c 1 postgres >/dev/null 2>&1; then
    success "‚úÖ API ‚Üí PostgreSQL: Conectividade OK"
else
    error "‚ùå API ‚Üí PostgreSQL: Falha na conectividade"
fi

if docker-compose -f docker-compose.production.yml exec -T api ping -c 1 redis >/dev/null 2>&1; then
    success "‚úÖ API ‚Üí Redis: Conectividade OK"
else
    error "‚ùå API ‚Üí Redis: Falha na conectividade"
fi

# ================================================================
# 4. TESTES DE ENDPOINTS
# ================================================================
section "4. TESTES DE ENDPOINTS"

log "Testando endpoints externos..."

# API
if curl -f -s --max-time 5 http://localhost:8000/health >/dev/null 2>&1; then
    success "‚úÖ API Health: http://localhost:8000/health"
    API_RESPONSE=$(curl -s http://localhost:8000/ 2>/dev/null || echo "ERRO")
    echo "   Resposta: $API_RESPONSE"
else
    error "‚ùå API Health: http://localhost:8000/health"
fi

# Dashboard
if curl -f -s --max-time 5 http://localhost:8501 >/dev/null 2>&1; then
    success "‚úÖ Dashboard: http://localhost:8501"
else
    error "‚ùå Dashboard: http://localhost:8501"
fi

# Grafana
if curl -f -s --max-time 5 http://localhost:3000/api/health >/dev/null 2>&1; then
    success "‚úÖ Grafana: http://localhost:3000"
else
    error "‚ùå Grafana: http://localhost:3000"
fi

# Nginx
if curl -f -s --max-time 5 http://localhost:80 >/dev/null 2>&1; then
    success "‚úÖ Nginx: http://localhost:80"
else
    error "‚ùå Nginx: http://localhost:80"
fi

# ================================================================
# 5. ESTRUTURA DE ARQUIVOS
# ================================================================
section "5. ESTRUTURA DE ARQUIVOS"

log "Verificando estrutura de arquivos no container da API..."

if docker-compose -f docker-compose.production.yml exec -T api ls -la /app/src/api/main.py >/dev/null 2>&1; then
    success "‚úÖ /app/src/api/main.py existe"
else
    error "‚ùå /app/src/api/main.py n√£o encontrado"
fi

if docker-compose -f docker-compose.production.yml exec -T api ls -la /app/config/settings.py >/dev/null 2>&1; then
    success "‚úÖ /app/config/settings.py existe"
    
    # Verificar conte√∫do do settings.py
    log "Verificando conte√∫do do config/settings.py..."
    SETTINGS_CONTENT=$(docker-compose -f docker-compose.production.yml exec -T api head -5 /app/config/settings.py 2>/dev/null || echo "ERRO")
    if [[ "$SETTINGS_CONTENT" == *"extra = \"allow\""* ]] || [[ "$SETTINGS_CONTENT" == *"Enterprise"* ]]; then
        success "‚úÖ Config/settings.py parece ser a vers√£o enterprise"
    else
        warning "‚ö†Ô∏è Config/settings.py pode ser vers√£o antiga"
        echo "   Primeiras linhas: $SETTINGS_CONTENT"
    fi
else
    error "‚ùå /app/config/settings.py n√£o encontrado"
fi

# ================================================================
# 6. TESTES DE IMPORTS PYTHON
# ================================================================
section "6. TESTES DE IMPORTS PYTHON"

log "Testando imports Python no container da API..."

# Teste de import b√°sico
IMPORT_TEST=$(docker-compose -f docker-compose.production.yml exec -T api python -c "import sys; print('Python OK')" 2>&1 || echo "ERRO")
if [[ "$IMPORT_TEST" == *"Python OK"* ]]; then
    success "‚úÖ Python funcionando"
else
    error "‚ùå Python com problema: $IMPORT_TEST"
fi

# Teste de import FastAPI
FASTAPI_TEST=$(docker-compose -f docker-compose.production.yml exec -T api python -c "import fastapi; print('FastAPI OK')" 2>&1 || echo "ERRO")
if [[ "$FASTAPI_TEST" == *"FastAPI OK"* ]]; then
    success "‚úÖ FastAPI importando"
else
    error "‚ùå FastAPI com problema: $FASTAPI_TEST"
fi

# Teste de import AsyncPG
ASYNCPG_TEST=$(docker-compose -f docker-compose.production.yml exec -T api python -c "import asyncpg; print('AsyncPG OK')" 2>&1 || echo "ERRO")
if [[ "$ASYNCPG_TEST" == *"AsyncPG OK"* ]]; then
    success "‚úÖ AsyncPG instalado"
else
    error "‚ùå AsyncPG com problema: $ASYNCPG_TEST"
fi

# Teste de import das configura√ß√µes
CONFIG_TEST=$(docker-compose -f docker-compose.production.yml exec -T api python -c "from config.settings import settings; print('Config OK')" 2>&1 || echo "ERRO")
if [[ "$CONFIG_TEST" == *"Config OK"* ]]; then
    success "‚úÖ Config/settings importando"
else
    error "‚ùå Config/settings com problema:"
    echo "   Erro: $CONFIG_TEST"
fi

# Teste de import da API principal
API_IMPORT_TEST=$(docker-compose -f docker-compose.production.yml exec -T api python -c "import src.api.main; print('API Main OK')" 2>&1 || echo "ERRO")
if [[ "$API_IMPORT_TEST" == *"API Main OK"* ]]; then
    success "‚úÖ src.api.main importando"
else
    error "‚ùå src.api.main com problema:"
    echo "   Erro: $API_IMPORT_TEST"
fi

# ================================================================
# 7. VARI√ÅVEIS DE AMBIENTE
# ================================================================
section "7. VARI√ÅVEIS DE AMBIENTE"

log "Verificando vari√°veis de ambiente no container da API..."

ENV_VARS=$(docker-compose -f docker-compose.production.yml exec -T api env | grep -E "(POSTGRES|REDIS|JWT|API)" | head -10 2>/dev/null || echo "ERRO")
if [[ "$ENV_VARS" != "ERRO" ]]; then
    success "‚úÖ Vari√°veis de ambiente carregadas:"
    echo "$ENV_VARS"
else
    error "‚ùå Problema ao acessar vari√°veis de ambiente"
fi

# ================================================================
# 8. BANCO DE DADOS
# ================================================================
section "8. BANCO DE DADOS"

log "Testando conectividade com PostgreSQL..."

# Teste de conex√£o com PostgreSQL
PG_TEST=$(docker-compose -f docker-compose.production.yml exec -T postgres pg_isready -U trading_user -d crypto_trading 2>&1 || echo "ERRO")
if [[ "$PG_TEST" == *"accepting connections"* ]]; then
    success "‚úÖ PostgreSQL aceitando conex√µes"
else
    error "‚ùå PostgreSQL com problema: $PG_TEST"
fi

# Teste de conex√£o com Redis
REDIS_TEST=$(docker-compose -f docker-compose.production.yml exec -T redis redis-cli ping 2>&1 || echo "ERRO")
if [[ "$REDIS_TEST" == *"PONG"* ]]; then
    success "‚úÖ Redis respondendo"
else
    error "‚ùå Redis com problema: $REDIS_TEST"
fi

# ================================================================
# 9. RECURSOS DO SISTEMA
# ================================================================
section "9. RECURSOS DO SISTEMA"

log "Verificando uso de recursos..."

# Uso de CPU e mem√≥ria dos containers
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" $(docker ps --filter "name=crypto-trading" -q) 2>/dev/null || echo "Erro ao obter estat√≠sticas"

# ================================================================
# 10. RESUMO E RECOMENDA√á√ïES
# ================================================================
section "10. RESUMO E RECOMENDA√á√ïES"

log "Analisando resultados do diagn√≥stico..."

echo ""
diagnostic "üìä RESUMO DOS PROBLEMAS ENCONTRADOS:"

# Contar problemas
PROBLEMS=0

# Verificar se API est√° funcionando
if ! curl -f -s --max-time 5 http://localhost:8000/health >/dev/null 2>&1; then
    error "üö® PROBLEMA CR√çTICO: API n√£o est√° respondendo"
    PROBLEMS=$((PROBLEMS + 1))
fi

# Verificar se config est√° funcionando
CONFIG_CHECK=$(docker-compose -f docker-compose.production.yml exec -T api python -c "from config.settings import settings; print('OK')" 2>&1 || echo "ERRO")
if [[ "$CONFIG_CHECK" == *"ERRO"* ]]; then
    error "üö® PROBLEMA CR√çTICO: Config/settings.py com erro"
    PROBLEMS=$((PROBLEMS + 1))
fi

# Verificar se Dashboard est√° funcionando
if ! curl -f -s --max-time 5 http://localhost:8501 >/dev/null 2>&1; then
    warning "‚ö†Ô∏è PROBLEMA: Dashboard n√£o est√° respondendo"
    PROBLEMS=$((PROBLEMS + 1))
fi

echo ""
if [ $PROBLEMS -eq 0 ]; then
    success "üéâ SISTEMA FUNCIONANDO PERFEITAMENTE!"
    success "üèÜ Nenhum problema cr√≠tico encontrado!"
else
    diagnostic "üìã TOTAL DE PROBLEMAS ENCONTRADOS: $PROBLEMS"
    echo ""
    diagnostic "üîß RECOMENDA√á√ïES:"
    
    if [[ "$CONFIG_CHECK" == *"ERRO"* ]]; then
        echo "   1. üéØ PRIORIDADE ALTA: Corrigir config/settings.py"
        echo "      Comando: ./aplicar_config_definitiva.sh"
    fi
    
    if ! curl -f -s --max-time 5 http://localhost:8000/health >/dev/null 2>&1; then
        echo "   2. üéØ PRIORIDADE ALTA: Reiniciar API"
        echo "      Comando: docker-compose -f docker-compose.production.yml restart api"
    fi
    
    if ! curl -f -s --max-time 5 http://localhost:8501 >/dev/null 2>&1; then
        echo "   3. üéØ PRIORIDADE M√âDIA: Verificar Dashboard"
        echo "      Comando: docker-compose -f docker-compose.production.yml logs dashboard"
    fi
fi

echo ""
echo "=================================================================="
echo "üîç DIAGN√ìSTICO COMPLETO FINALIZADO"
echo "üìä Relat√≥rio gerado em $(date)"
echo "=================================================================="

