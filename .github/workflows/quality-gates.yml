name: Quality Gates

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Executar diariamente Ã s 2 AM
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pylint radon

      - name: Run linting
        run: |
          echo "### ðŸ” Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Flake8
          echo "#### Flake8" >> $GITHUB_STEP_SUMMARY
          flake8 . --count --statistics --format=default > flake8_report.txt || true
          cat flake8_report.txt >> $GITHUB_STEP_SUMMARY
          
          # Black
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Black" >> $GITHUB_STEP_SUMMARY
          black . --check --diff > black_report.txt || true
          
          if [ -s black_report.txt ]; then
            echo "âš ï¸ Code formatting issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Code is properly formatted" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check code complexity
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Code Complexity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Radon - Complexidade ciclomÃ¡tica
          radon cc . -a -s > complexity_report.txt || true
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 complexity_report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se hÃ¡ funÃ§Ãµes com complexidade muito alta (> 10)
          HIGH_COMPLEXITY=$(radon cc . -n C -s | wc -l)
          
          if [ "$HIGH_COMPLEXITY" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ $HIGH_COMPLEXITY functions with high complexity (> 10)" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… No functions with excessive complexity" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check maintainability index
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Maintainability Index" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          radon mi . -s > maintainability_report.txt || true
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          head -20 maintainability_report.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # A = 100-20, B = 20-10, C = 10-0
          LOW_MAINTAINABILITY=$(radon mi . -n C -s | wc -l)
          
          if [ "$LOW_MAINTAINABILITY" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ $LOW_MAINTAINABILITY files with low maintainability" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All files have good maintainability" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports
          path: |
            flake8_report.txt
            black_report.txt
            complexity_report.txt
            maintainability_report.txt

  test-coverage:
    name: Test Coverage Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov coverage

      - name: Run tests with coverage
        run: |
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing

      - name: Coverage report
        run: |
          echo "### ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          coverage report >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Obter percentual de cobertura
          COVERAGE=$(coverage report | grep TOTAL | awk '{print $4}' | sed 's/%//')
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Coverage:** $COVERAGE%" >> $GITHUB_STEP_SUMMARY
          
          # Quality gate: cobertura mÃ­nima de 80%
          if [ "${COVERAGE%.*}" -lt 80 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Coverage below threshold (80%)" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Coverage meets threshold (â‰¥80%)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.repository_owner }}_crypto-trading-mvp
            -Dsonar.organization=${{ github.repository_owner }}

      - name: SonarCloud Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install safety
        run: pip install safety

      - name: Check dependencies
        run: |
          echo "### ðŸ”’ Dependency Vulnerability Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          safety check --json > safety_report.json || true
          
          # Contar vulnerabilidades
          VULN_COUNT=$(cat safety_report.json | grep -o '"vulnerability"' | wc -l)
          
          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "âš ï¸ $VULN_COUNT vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See safety_report.json for details" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload safety report
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety_report.json

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test-coverage, dependency-check]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸŽ¯ Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "âœ… Code Quality: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Code Quality: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-coverage.result }}" == "success" ]; then
            echo "âœ… Test Coverage: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Test Coverage: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.dependency-check.result }}" == "success" ]; then
            echo "âœ… Dependency Check: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Dependency Check: WARNINGS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Verificar se todos passaram
          if [ "${{ needs.code-quality.result }}" == "success" ] && \
             [ "${{ needs.test-coverage.result }}" == "success" ]; then
            echo "### âœ… All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some Quality Gates Failed" >> $GITHUB_STEP_SUMMARY
          fi
